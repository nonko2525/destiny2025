<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Unmei - 出会いが鳴り、恋が奏でる運命</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet">

<style>
  :root { --gold:#d8bd6a; --gold-glow:rgba(216,189,106,.85); }

  *{ box-sizing:border-box; }
  html,body{ height:100%; }
  body{
    margin:0; background:#000; color:var(--gold);
    font-family:'Playfair Display',serif;
    overflow:hidden;
  }

  /* ====== 共通：画面 ====== */
  .screen{
    position:absolute; inset:0; display:grid; place-items:center;
    background:radial-gradient(1200px 600px at 50% -10%, #180e0e 0%, #000 70%);
    opacity:1; transition:opacity .5s ease, transform .5s ease;
  }
  .hidden{ opacity:0; pointer-events:none; transform:scale(.98); }

  /* ====== ホーム（ヒーロー） ====== */
  .hero{
    width:min(1100px, 92vw);
    display:flex; flex-direction:column; align-items:center; gap:22px;
    text-align:center;
  }
  .hero h1{
    font-size: clamp(64px, 12vw, 132px);
    margin:0; letter-spacing:4px; color:var(--gold);
    text-shadow:0 0 28px var(--gold-glow);
  }
  .tagline{
    display:inline-block; padding:10px 16px;
    font-size:clamp(16px, 2.6vw, 28px); letter-spacing:3px; color:var(--gold);
    background:rgba(0,0,0,.35); border:1px solid rgba(216,189,106,.35);
    border-radius:12px; backdrop-filter:blur(2px);
  }
  .divider{ width:100%; height:1px;
    background:linear-gradient(90deg,transparent,rgba(216,189,106,.4),transparent); }

  .auth{
    margin-top:14px; width:min(900px,92vw);
    background:linear-gradient(180deg,rgba(255,255,255,.05),rgba(0,0,0,.2));
    border:1px solid rgba(216,189,106,.25); border-radius:16px; padding:18px;
    box-shadow:0 10px 40px rgba(0,0,0,.45), inset 0 0 40px rgba(216,189,106,.07);
  }
  .auth-tabs{ display:flex; gap:10px; margin-bottom:12px; }
  .auth-tab{
    flex:1; padding:10px 12px; cursor:pointer; border-radius:10px;
    background:#1b1212; border:1px solid rgba(216,189,106,.35);
    color:var(--gold); font-size:16px;
  }
  .auth-tab.active{ background:#37201c; border-color:var(--gold); }
  .auth-pane{ display:none; }
  .auth-pane.active{ display:grid; grid-template-columns:repeat(2,1fr); gap:14px; }
  .field{ display:flex; flex-direction:column; gap:6px; text-align:left; }
  .field label{ font-size:14px; opacity:.95; }
  .field input, .field select{
    padding:10px; border-radius:10px; border:1px solid #443;
    background:#0e0a0a; color:#fff; font-size:15px;
  }
  .actions{ grid-column:1/-1; display:flex; gap:10px; justify-content:flex-end; }
  .btn{
    padding:10px 16px; border-radius:10px; border:1px solid var(--gold);
    background:#2a1412; color:var(--gold); cursor:pointer; font-size:16px;
    transition:transform .2s, box-shadow .25s, filter .25s;
  }
  .btn:hover{ transform:translateY(-1px); box-shadow:0 0 20px rgba(216,189,106,.35); filter:brightness(1.02); }
  .btn.ghost{ border-color:#666; color:#ddd; background:#111; }
  .note{ margin:4px 0 0; font-size:12px; opacity:.8; grid-column:1/-1; }
  .current{
    margin-top:10px; padding:10px; border:1px dashed rgba(216,189,106,.35);
    border-radius:10px; font-size:14px; text-align:left;
  }

  /* 画像アップのプレビュー */
  .avatar-preview{
    width:96px; height:96px; border-radius:50%; border:2px solid var(--gold);
    object-fit:cover; background:#000; box-shadow:0 0 12px rgba(216,189,106,.25);
  }

  /* ====== メイン（スロット＋鍵盤） ====== */
  .stage-wrap{ position:relative; width:100vw; height:100vh; overflow:hidden; display:grid; place-items:center; }
  .stage{
    position:absolute; left:50%; top:50%;
    width:1280px; height:720px; transform-origin:center;
    background:radial-gradient(circle at center,#1c0d0d 0%,#000 80%);
    border-radius:10px; box-shadow:0 0 40px rgba(216,189,106,.08) inset;
  }

  /* アカウント表示＆ログアウトボタン */
  .account-chip{
    position:absolute; right:140px; top:24px;
    padding:8px 12px; border-radius:999px;
    background:linear-gradient(180deg,rgba(0,0,0,.45),rgba(0,0,0,.25));
    border:1px solid rgba(216,189,106,.45);
    color:var(--gold); font-size:14px; letter-spacing:1px;
    box-shadow:0 6px 18px rgba(0,0,0,.35), inset 0 0 18px rgba(216,189,106,.12);
    backdrop-filter: blur(6px);
  }
  .logout-btn{
    position:absolute; right:24px; top:20px;
    padding:10px 14px; border-radius:12px;
    color:var(--gold); background:linear-gradient(180deg,rgba(40,20,18,.75),rgba(20,10,8,.65));
    border:1px solid rgba(216,189,106,.6);
    box-shadow:
      0 8px 22px rgba(0,0,0,.45),
      inset 0 0 22px rgba(216,189,106,.12);
    text-shadow:0 0 10px var(--gold-glow);
    cursor:pointer;
    transition: transform .15s ease, box-shadow .25s ease, filter .25s ease, border-color .25s ease;
  }
  .logout-btn:hover{
    transform: translateY(-1px);
    filter: brightness(1.06);
    border-color: var(--gold);
    box-shadow:
      0 12px 28px rgba(0,0,0,.55),
      0 0 22px rgba(216,189,106,.35),
      inset 0 0 26px rgba(216,189,106,.18);
  }
  .logout-btn:active{ transform: translateY(0); filter: brightness(1.0); }

  h2.app-title{
    position:absolute; left:50%; top:40px; transform:translateX(-50%);
    margin:0; font-size:72px; letter-spacing:3px; text-shadow:0 0 25px var(--gold-glow);
  }
  .subtitle{
    position:absolute; left:50%; top:120px; transform:translateX(-50%);
    margin:0; font-size:22px; letter-spacing:2px; text-shadow:0 0 15px rgba(216,189,106,.8); text-align:center;
  }
  .slot{ position:absolute; left:50%; top:160px; transform:translateX(-50%); display:flex; gap:16px; }
  .slot-box{
    width:120px; height:100px; background:linear-gradient(180deg,#2a1b1b,#3a0303);
    border:2px solid var(--gold); border-radius:12px; display:flex; align-items:center; justify-content:center;
    text-align:center; font-weight:700; font-size:20px; box-shadow:0 0 15px rgba(216,189,106,.45);
    user-select:none; transition:filter .2s, box-shadow .2s;
  }
  .spinning{ filter:saturate(1.2) brightness(1.1); box-shadow:0 0 18px rgba(216,189,106,.6); }
  .stopped{ filter:none; }

  /* ボタン（そのまま） */
  .cta{
    position:absolute; left:50%; top:340px; transform:translateX(-50%);
    background:linear-gradient(90deg,#8b0000,#b30000); color:var(--gold);
    border:2px solid var(--gold); border-radius:12px; padding:14px 36px; font-size:24px; cursor:pointer;
    text-shadow:0 0 12px rgba(216,189,106,.8); box-shadow:0 0 25px rgba(216,189,106,.35);
    transition:transform .25s, box-shadow .25s, filter .25s; z-index:5;
  }
  .cta:hover{ transform:translateX(-50%) translateY(-1px) scale(1.04); box-shadow:0 0 35px rgba(216,189,106,.8); filter:brightness(1.05); }
  .cta:active{ transform:translateX(-50%) translateY(0) scale(.98); box-shadow:0 0 22px rgba(216,189,106,.6); }

  .keys{ position:absolute; left:50%; bottom:0; transform:translateX(-50%); display:flex; gap:2px; padding:8px 0 10px; pointer-events:none; }
  .key{ width:64px; height:280px; background:linear-gradient(to bottom,#fff,#ddd); border:1px solid #444; border-radius:4px; position:relative; box-shadow:0 4px 10px rgba(255,255,255,.08); }
  .key.black{ width:42px; height:180px; background:linear-gradient(to bottom,#111,#000); margin:0 -21px; z-index:2; border-color:#222; box-shadow:0 4px 10px rgba(0,0,0,.35); }
  .flash{ box-shadow:0 0 22px rgba(216,189,106,.9)!important; filter:brightness(2) saturate(1.2); }

  .footer-note{ position:absolute; left:50%; bottom:8px; transform:translateX(-50%); font-size:14px; opacity:.85; }

  /* ====== 結果表示 ====== */
  .result-line, .result-summary, .result-me{
    position:absolute; left:50%; transform:translateX(-50%); text-shadow:0 0 18px rgba(216,189,106,.9);
    opacity:0; transition:opacity .9s ease; text-align:center; white-space:pre-wrap; letter-spacing:2px;
  }
  .result-line{ top:300px; font-size:28px; }         /* 「あなたの運命の相手は…」 */
  .result-me{ top:400px; font-size:20px; }           /* あなたのプロフィール行（独立） */
  .result-summary{ top:440px; font-size:20px; max-width:150vw; } /* ← 少し上へ（520→495） */

  .show{ opacity:1; }

  /*  #resultSummary にだけ背景プレートを付与 */
  #resultSummary{
    display:inline-block;
    background:linear-gradient(180deg,rgba(0,0,0,.6),rgba(0,0,0,.4));
    border:1px solid rgba(216,189,106,.4);
    border-radius:14px;
    padding:14px 22px;
    box-shadow:0 10px 25px rgba(0,0,0,.45), inset 0 0 25px rgba(216,189,106,.15);
    backdrop-filter:blur(4px);
  }

  /* ===== 紹介ページ ===== */
  .cards{ display:flex; gap:18px; flex-wrap:wrap; justify-content:center; }
  .card{
    width:230px; background:#1b1212;
    border:1px solid rgba(216,189,106,.35); border-radius:16px;
    padding:12px; display:flex; flex-direction:column; align-items:center;
    box-shadow:0 0 16px rgba(216,189,106,.15);
  }
  .card img{ width:160px; height:160px; border-radius:50%; object-fit:cover; border:2px solid var(--gold); }
  .card .meta{ text-align:center; margin-top:8px; line-height:1.4; }
  .card .btn{ margin-top:8px; width:100%; }

  @media (max-width:980px){ .auth-pane.active{ grid-template-columns:1fr; } }
</style>
</head>
<body>

<!-- ===== ホーム（ログイン/新規登録） ===== -->
<section id="home" class="screen">
  <div class="hero">
    <h1>Unmei</h1>
    <div class="tagline">出会いは偶然の音。恋はあなたが奏でる運命。</div>
    <div class="divider"></div>

    <div class="auth">
      <div class="auth-tabs">
        <button class="auth-tab active" data-tab="login">ログイン</button>
        <button class="auth-tab" data-tab="register">新規登録</button>
      </div>

      <!-- ログイン -->
      <div id="pane-login" class="auth-pane active">
        <div class="field" style="grid-column:1/-1;">
          <label>ユーザー選択</label>
          <select id="loginUser"></select>
        </div>
        <div class="actions">
          <button id="doLogin" class="btn">ログイン</button>
          <button id="deleteUser" class="btn ghost">選択ユーザー削除</button>
        </div>
        <div id="currentUserView" class="current">未ログイン</div>
      </div>

      <!-- 新規登録 -->
      <div id="pane-register" class="auth-pane">
        <div class="field">
          <label>表示名（偽名OK）</label>
          <input id="regName" type="text" placeholder="例：あり / Take" />
        </div>
        <div class="field">
          <label>年齢</label>
          <input id="regAge" type="number" min="10" max="120" placeholder="例：21" />
        </div>
        <div class="field">
          <label>顔の系統</label>
          <select id="regFace"></select>
        </div>
        <div class="field">
          <label>MBTI</label>
          <select id="regMBTI"></select>
        </div>
        <div class="field">
          <label>国籍</label>
          <select id="regCountry"></select>
        </div>
        <div class="field" style="grid-column:1/-1;display:flex;align-items:center;gap:12px;">
          <div>
            <label>プロフィール画像（任意）</label>
            <input id="regImg" type="file" accept="image/*" />
            <div class="note">※ 端末内にのみ保存（localStorage）。</div>
          </div>
          <img id="regPreview" class="avatar-preview" alt="preview" />
        </div>

        <div class="actions">
          <button id="doRegister" class="btn">登録する</button>
          <button id="toLogin" class="btn ghost">ログインへ</button>
        </div>
        <p class="note">※ 保存はこの端末（localStorage）のみ。表示名は偽名でOK。</p>
      </div>
    </div>
  </div>
</section>

<!-- ===== メイン（ゲーム） ===== -->
<section id="main" class="screen hidden">
  <div class="stage-wrap">
    <div class="stage" id="stage">
      <div class="account-chip" id="accountChip">未ログイン</div>
      <button id="openLogout" class="logout-btn" aria-label="ログアウト">ログアウト</button>

      <h2 class="app-title">Unmei</h2>
      <p class="subtitle">出会いは偶然の音。恋はあなたが奏でる運命</p>

      <div class="slot" aria-live="polite">
        <div class="slot-box" data-field="height">身長</div>
        <div class="slot-box" data-field="face">顔</div>
        <div class="slot-box" data-field="mbti">MBTI</div>
        <div class="slot-box" data-field="age">年齢</div>
        <div class="slot-box" data-field="country">国籍</div>
      </div>

      <button class="cta" aria-label="運命を奏でる（スタート）">運命を奏でる</button>

      <audio id="bgm" preload="auto" playsinline>
        <source src="beethoven_symphony5_1.mp3" type="audio/mpeg" />
      </audio>

      <div class="keys" aria-hidden="true">
        <div class="key"></div><div class="key black"></div><div class="key"></div><div class="key black"></div>
        <div class="key"></div><div class="key"></div><div class="key black"></div><div class="key"></div>
        <div class="key black"></div><div class="key"></div><div class="key black"></div><div class="key"></div>
        <div class="key"></div><div class="key black"></div><div class="key"></div><div class="key black"></div>
        <div class="key"></div><div class="key"></div><div class="key black"></div><div class="key"></div>
        <div class="key black"></div><div class="key"></div><div class="key black"></div><div class="key"></div>
        <div class="key"></div><div class="key black"></div><div class="key"></div><div class="key black"></div><div class="key"></div>
      </div>

      <div class="footer-note">© 2025 Unmei Project</div>

      <div class="result-line" id="resultLine">あなたの運命の相手は...</div>
      <div class="result-me" id="resultMe"></div>          <!-- あなたの行 -->
      <div class="result-summary" id="resultSummary"></div>
    </div>
  </div>
</section>

<!-- ===== 紹介ページ ===== -->
<section id="intro" class="screen hidden">
  <div class="hero" style="gap:14px;">
    <h1>運命の紹介</h1>
    <div class="tagline" style="white-space:pre-wrap;">
      これは偶然の旋律か、 それとも──運命のデュエットか。
    </div>
    <div class="divider"></div>
    <div id="introCards" class="cards"></div>
    <div class="divider"></div>
    <div style="display:flex;gap:10px;">
      <button id="backToMain" class="btn">もう一度占う</button>
      <button id="backToHome" class="btn ghost">ホームへ戻る</button>
    </div>
  </div>
</section>

<!-- ===== ログアウト確認画面 ===== -->
<section id="logout" class="screen hidden">
  <div class="hero" style="gap:16px;">
    <h1 style="font-size:clamp(40px,9vw,88px);">ログアウト</h1>
    <div class="tagline">また会いましょう。次の一音は、きっとあなたが奏でる。</div>
    <div class="divider"></div>
    <div style="display:flex; gap:12px; margin-top:8px;">
      <button id="doLogout" class="btn">ログアウトしてホームへ</button>
      <button id="cancelLogout" class="btn ghost">キャンセル</button>
    </div>
  </div>
</section>

<script>
(function(){
  /* ===== 画面参照 ===== */
  const home = document.getElementById('home');
  const main = document.getElementById('main');
  const intro = document.getElementById('intro');
  const logoutScr = document.getElementById('logout');

  function goMain(){ home.classList.add('hidden'); intro.classList.add('hidden'); logoutScr.classList.add('hidden'); main.classList.remove('hidden'); requestAnimationFrame(fitStage); }
  function goHome(){ main.classList.add('hidden'); intro.classList.add('hidden'); logoutScr.classList.add('hidden'); home.classList.remove('hidden'); }
  function goLogout(){ home.classList.add('hidden'); main.classList.add('hidden'); intro.classList.add('hidden'); logoutScr.classList.remove('hidden'); }
  function goIntro(picked, top3){
    main.classList.add('hidden');
    intro.classList.remove('hidden');
    renderIntro(top3);
  }

  /* ===== ステージ縮尺 ===== */
  const stage = document.getElementById('stage');
  const BASE_W = 1280, BASE_H = 720;
  function fitStage(){
    if(!stage) return;
    const wrap = stage.parentElement;
    const sw = wrap.clientWidth, sh = wrap.clientHeight;
    const scale = Math.min(sw/BASE_W, sh/BASE_H);
    stage.style.transform = `translate(-50%, -50%) scale(${scale})`;
  }
  window.addEventListener('resize', fitStage);
  window.addEventListener('orientationchange', fitStage);
  new ResizeObserver(fitStage).observe(document.body);

  /* ===== データ ===== */
  const faces = ["しお顔","ソース顔","とんこつ顔","砂糖顔","しょうゆ顔","塩バター顔"];
  const mbti = ["INTJ","INFP","ENTP","ENFJ","ISTP","ISFP","ESTJ","ESFP","ISTJ","INFJ","ENTJ","ENFP","ISFJ","ESFJ","ESTP","INTP"];
  const countries = ["日本","韓国","フランス","イギリス","ドイツ","イタリア","アメリカ","ブラジル","エジプト","タイ","スペイン","カナダ","オーストラリア"];
  const defaultAvatar = 'data:image/svg+xml;utf8,' + encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="300" height="300"><rect width="100%" height="100%" fill="black"/><circle cx="150" cy="120" r="70" fill="#333"/><rect x="60" y="200" width="180" height="80" rx="40" fill="#333"/></svg>`);

  /* ===== Auth（localStorage） ===== */
  const USERS_KEY="unmeiUsers", CURRENT_ID_KEY="unmeiCurrentUserId", MSGS_KEY="unmeiMsgs";
  const $=(s)=>document.querySelector(s);

  const tabs=Array.from(document.querySelectorAll(".auth-tab"));
  const paneLogin=$("#pane-login"), paneRegister=$("#pane-register");
  const loginSelect=$("#loginUser"), doLoginBtn=$("#doLogin"), delUserBtn=$("#deleteUser");
  const curView=$("#currentUserView");
  const regName=$("#regName"), regAge=$("#regAge"), regFace=$("#regFace"), regMBTI=$("#regMBTI"), regCountry=$("#regCountry");
  const regImg=$("#regImg"), regPreview=$("#regPreview");
  const doRegisterBtn=$("#doRegister"), toLoginBtn=$("#toLogin");
  const accountChip=document.getElementById("accountChip");

  const openLogoutBtn=document.getElementById('openLogout');
  const doLogoutBtn=document.getElementById('doLogout');
  const cancelLogoutBtn=document.getElementById('cancelLogout');

  const introCards = document.getElementById('introCards');
  const backToMain = document.getElementById('backToMain');
  const backToHome = document.getElementById('backToHome');

  function fillOptions(el, arr){
    el.innerHTML = '<option value="">（未設定）</option>' + arr.map(v=>`<option value="${v}">${v}</option>`).join('');
  }
  fillOptions(regFace, faces); fillOptions(regMBTI, mbti); fillOptions(regCountry, countries);

  function loadUsers(){ try{ return JSON.parse(localStorage.getItem(USERS_KEY)||"[]"); }catch(_){ return []; } }
  function saveUsers(list){ localStorage.setItem(USERS_KEY, JSON.stringify(list)); }
  function setCurrentId(id){ id? localStorage.setItem(CURRENT_ID_KEY,String(id)) : localStorage.removeItem(CURRENT_ID_KEY); }
  function getCurrentId(){ return localStorage.getItem(CURRENT_ID_KEY); }
  function getCurrentUser(){ const id=getCurrentId(); if(!id) return null; return loadUsers().find(u=>String(u.id)===String(id))||null; }

  function refreshLoginSelect(){
    const users=loadUsers();
    loginSelect.innerHTML = users.length
      ? users.map(u=>`<option value="${u.id}">${u.displayName} (${u.country||'国籍不明'})</option>`).join('')
      : '<option value="">（ユーザー未登録）</option>';
  }
  function refreshCurrentView(){
    const me=getCurrentUser();
    if(me){
      curView.textContent=`ログイン中：${me.displayName} / ${me.age?me.age+'歳':'年齢:不明'} / ${me.face||'顔の系統:不明'} / ${me.mbti||'MBTI:不明'} / ${me.country||'国籍:不明'}`;
      accountChip.textContent=me.displayName;
    }else{
      curView.textContent='未ログイン';
      accountChip.textContent='未ログイン';
    }
  }
  refreshLoginSelect(); refreshCurrentView();

  tabs.forEach(b=>{
    b.addEventListener('click', ()=>{
      tabs.forEach(x=>x.classList.remove('active')); b.classList.add('active');
      const isLogin=b.dataset.tab==='login';
      paneLogin.classList.toggle('active',isLogin);
      paneRegister.classList.toggle('active',!isLogin);
    });
  });
  toLoginBtn.addEventListener('click', ()=> tabs.find(t=>t.dataset.tab==='login').click());

  // プレビュー
  regImg.addEventListener('change', ()=>{
    const f=regImg.files && regImg.files[0];
    if(!f){ regPreview.src=''; return; }
    const reader=new FileReader();
    reader.onload=e=>{ regPreview.src=e.target.result; };
    reader.readAsDataURL(f);
  });

  // 画像→Base64 Promise
  function fileToDataURL(file){
    return new Promise((resolve,reject)=>{
      const r=new FileReader();
      r.onload=e=>resolve(e.target.result);
      r.onerror=reject;
      r.readAsDataURL(file);
    });
  }

  // 登録
  doRegisterBtn.addEventListener('click', async ()=>{
    const name=(regName.value||'').trim(); if(!name){ alert('表示名（偽名OK）を入力してください'); return; }
    const age=regAge.value ? Math.max(0,Math.min(150, Number(regAge.value)|0)) : "";
    let imgData="";
    const f=regImg.files && regImg.files[0];
    if(f){ try{ imgData=await fileToDataURL(f); }catch(_){ imgData=""; } }
    const user={ id:Date.now().toString(36)+Math.random().toString(36).slice(2,7),
      displayName:name, age:age?String(age):"", face:regFace.value||"", mbti:regMBTI.value||"", country:regCountry.value||"", img:imgData };
    const list=loadUsers(); list.push(user); saveUsers(list);
    setCurrentId(user.id); refreshLoginSelect(); refreshCurrentView();
    alert('登録しました！ゲーム画面へ移動します。'); goMain();
  });

  // ログイン
  doLoginBtn.addEventListener('click', ()=>{
    const id=loginSelect.value; if(!id){ alert('ユーザーを選択してください'); return; }
    setCurrentId(id); refreshCurrentView(); alert('ログインしました。ゲーム画面へ移動します。'); goMain();
  });

  // ユーザー削除
  delUserBtn.addEventListener('click', ()=>{
    const id=loginSelect.value; if(!id){ alert('削除するユーザーを選択してください'); return; }
    const list=loadUsers(); const idx=list.findIndex(u=>String(u.id)===String(id));
    if(idx>=0 && confirm(`本当に削除しますか？\n${list[idx].displayName}`)){
      list.splice(idx,1); saveUsers(list); if(getCurrentId()===id) setCurrentId(null);
      refreshLoginSelect(); refreshCurrentView(); alert('削除しました');
    }
  });

  /* ===== メインのゲーム ===== */
  const boxes=[...document.querySelectorAll(".slot-box")];
  const keys=[...document.querySelectorAll(".keys .key")];
  const btn=document.querySelector(".cta"); const bgm=document.getElementById("bgm");
  const line=document.getElementById("resultLine"); const summary=document.getElementById("resultSummary");
  const meLineEl=document.getElementById("resultMe");

  const cues={ line:1500, height:4200, face:7500, mbti:9800, age:12100, country:14500, summary:17500 };
  const timeouts=[]; const spinners=[];
  function schedule(fn,d,s){ const h=setTimeout(fn, Math.max(0, s+d - performance.now())); timeouts.push(h); }
  function clearAll(){ while(timeouts.length){ clearTimeout(timeouts.pop()); } spinners.splice(0).forEach(id=>clearInterval(id)); }
  function flashKey(){ const k=keys[Math.floor(Math.random()*keys.length)]; if(!k) return; k.classList.add("flash"); setTimeout(()=>k.classList.remove("flash"),120); }
  function startSpin(){
    boxes.forEach(box=>{
      box.classList.add("spinning");
      const id=setInterval(()=>{
        switch(box.dataset.field){
          case "height": box.textContent=(150+Math.floor(Math.random()*51))+"cm"; break;
          case "face": box.textContent=faces[Math.floor(Math.random()*faces.length)]; break;
          case "mbti": box.textContent=mbti[Math.floor(Math.random()*mbti.length)]; break;
          case "age": box.textContent=(18+Math.floor(Math.random()*23))+"歳"; break;
          case "country": box.textContent=countries[Math.floor(Math.random()*countries.length)]; break;
        }
      },45);
      spinners.push(id);
    });
  }
  function stopBox(i){ if(spinners[i]){ clearInterval(spinners[i]); spinners[i]=null; }
    boxes[i].classList.remove("spinning"); boxes[i].classList.add("stopped"); flashKey(); return boxes[i].textContent; }

  function calcMatchScore(me,u){
    let score=0; if(me&&u){
      if(me.face&&u.face&&me.face===u.face) score+=30;
      if(me.mbti&&u.mbti&&me.mbti===u.mbti) score+=40;
      if(me.country&&u.country&&me.country===u.country) score+=20;
      const a=Number(me.age), b=Number(u.age); if(a&&b&&Math.abs(a-b)<=3) score+=10;
    } return score;
  }
  function rankTopMatches(me,k=3){
    const others=loadUsers().filter(u=>!me || u.id!==me.id);
    const scored=others.map(u=>({u, score:calcMatchScore(me,u)})).sort((a,b)=>b.score-a.score);
    return scored.slice(0,k);
  }

  function renderIntro(top3){
    const introCards = document.getElementById('introCards');
    introCards.innerHTML='';
    if(!top3 || !top3.length){
      introCards.innerHTML = '<div class="note">他の登録ユーザーがいません。ホームからユーザーを追加してください。</div>';
      return;
    }
    const defaultAvatar = 'data:image/svg+xml;utf8,' + encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="300" height="300"><rect width="100%" height="100%" fill="black"/><circle cx="150" cy="120" r="70" fill="#333"/><rect x="60" y="200" width="180" height="80" rx="40" fill="#333"/></svg>`);

    top3.forEach(({u,score})=>{
      const card=document.createElement('div');
      card.className='card';
      const imgSrc = u.img || defaultAvatar;
      card.innerHTML = `
        <img src="${imgSrc}" alt="${u.displayName}">
        <div class="meta">
          <strong>${u.displayName}</strong><br>
          ${u.mbti || 'MBTI不明'} / ${u.face || '顔:不明'}<br>
          ${u.country || '国籍:不明'}<br>
          <small>マッチ度：${score}%</small>
        </div>
        <button class="btn send-btn" data-id="${u.id}"> メッセージを送る</button>
      `;
      introCards.appendChild(card);
    });

    introCards.querySelectorAll('.send-btn').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const tid = btn.dataset.id;
        const msg = prompt('相手にメッセージを送ります：');
        if(!msg) return;
        const meId = getCurrentId();
        const box = JSON.parse(localStorage.getItem(MSGS_KEY) || '{}');
        box[tid] = box[tid] || [];
        box[tid].push({ from: meId, text: msg, time: Date.now() });
        localStorage.setItem(MSGS_KEY, JSON.stringify(box));
        alert('メッセージを送信しました');
      });
    });
  }

  async function runSequence(){
    clearAll();
    line.classList.remove("show");
    summary.classList.remove("show");
    meLineEl.classList.remove("show");
    summary.textContent=""; meLineEl.textContent="";
    boxes.forEach(b=>b.classList.remove("stopped"));

    await new Promise((resolve)=>{
      const ok=()=>{ bgm.removeEventListener("canplaythrough", ok); resolve(); };
      bgm.addEventListener("canplaythrough", ok, {once:true});
      if(bgm.readyState>=3 || bgm.duration>0) resolve();
      setTimeout(resolve,600);
    });
    try{ bgm.pause(); bgm.currentTime=0; await bgm.play(); }
    catch(e){ alert("再生がブロックされました。もう一度ボタンを押してください。"); return; }

    startSpin(); const start=performance.now();
    schedule(()=>{ line.classList.add("show"); }, cues.line, start);

    const picked={height:"",face:"",mbti:"",age:"",country:""};
    schedule(()=>{ picked.height=stopBox(0); }, cues.height, start);
    schedule(()=>{ picked.face=stopBox(1); }, cues.face, start);
    schedule(()=>{ picked.mbti=stopBox(2); }, cues.mbti, start);
    schedule(()=>{ picked.age=stopBox(3); }, cues.age, start);
    schedule(()=>{ picked.country=stopBox(4); }, cues.country, start);

    schedule(()=>{
      const label=`${picked.country} / ${picked.height} / ${picked.face} / ${picked.mbti} / ${picked.age}`;
      const me=getCurrentUser();



      /* ---- 相手と上位3人は下部プレートにまとめて表示 ---- */
      let top3Text='';
      if(me){
        const top3=rankTopMatches(me,3).filter(x=>x.u);
        if(top3.length){
          const lines=top3.map((it,i)=>{
            const u=it.u; return ` ${i+1}. ${u.displayName}（${u.mbti||'MBTI不明'} / ${u.face||'顔:不明'} / ${u.country||'国籍:不明'}） - マッチ度：${it.score}%`;
          }).join('\n');
          top3Text=`\n\n 運命の旋律を奏でた相手（上位3人）\n${lines}`;
        }else{ top3Text=`\n\n 他の登録ユーザーがいません。`; }
      }else{
        top3Text=`\n\n ログインすると、あなたに合う相手をご紹介できます。`;
      }

      const ending=`\n\nこれは偶然の旋律か、\nそれとも──運命のデュエットか。`;

      summary.textContent=`おめでとうございます！\n${label}\nが運命の相手です。` + top3Text + ending;
      summary.classList.add("show");
    }, cues.summary, start);

    // 自動で紹介ページへ（4秒後）
    schedule(()=>{
      const me=getCurrentUser();
      const top3 = me ? rankTopMatches(me,3) : [];
      goIntro(picked, top3);
    }, cues.summary + 4000, start);
  }

  let busy=false;
  document.querySelector(".cta").addEventListener("click", async ()=>{
    if(busy) return; busy=true;
    try{ await runSequence(); } finally{ setTimeout(()=>busy=false, 22000); }
  });

  /* ===== 紹介ページ：戻る ===== */
  backToMain.addEventListener('click', ()=> goMain());
  backToHome.addEventListener('click', ()=> goHome());

  /* ===== ログアウト動線 ===== */
  openLogoutBtn.addEventListener('click', ()=> goLogout());
  doLogoutBtn.addEventListener('click', ()=>{
    setCurrentId(null); accountChip.textContent='未ログイン';
    refreshLoginSelect(); refreshCurrentView(); goHome();
  });
  cancelLogoutBtn.addEventListener('click', ()=> goMain());

  /* 既にログイン済みならメインへ */
  if(getCurrentUser()){ goMain(); }
})();
</script>

<!-- ===== チャットページ ===== -->
<section id="chat" class="screen hidden">
  <div class="hero" style="gap:10px; width:100%; max-width:600px;">
    <h1 id="chatName"> メッセージ</h1>
    <div id="chatWindow" style="flex:1; width:100%; height:60vh; overflow-y:auto; background:rgba(0,0,0,.25); border:1px solid rgba(216,189,106,.3); border-radius:10px; padding:10px;"></div>
    <div style="display:flex; gap:8px; width:100%;">
      <input id="chatInput" type="text" placeholder="メッセージを入力..." style="flex:1; padding:10px; border-radius:10px; border:1px solid #444; background:#111; color:#fff;">
      <button id="sendMsg" class="btn">送信</button>
    </div>
    <button id="backToIntro" class="btn ghost">戻る</button>
  </div>
</section>

<style>
.bubble{
  display:inline-block; padding:10px 14px; border-radius:14px; margin:6px;
  max-width:70%; word-break:break-word; line-height:1.4;
}
.from-me{ background:#37201c; color:var(--gold); align-self:flex-end; margin-left:auto; }
.from-them{ background:#111; color:#fff; align-self:flex-start; margin-right:auto; }
.chat-msg{ display:flex; flex-direction:column; }
</style>

<script>
/* ===== チャットと紹介機能の拡張（別スクリプト） ===== */
(function(){
  const intro = document.getElementById('intro');
  const chat = document.getElementById('chat');
  const introCards = document.getElementById('introCards');
  const backToIntro = document.getElementById('backToIntro');
  const chatWindow = document.getElementById('chatWindow');
  const chatInput = document.getElementById('chatInput');

  // 「もっと見る」ボタンを最後のdividerの直後に追加
  const moreBtn = document.createElement('button');
  moreBtn.textContent = 'もっと見る（次の3人）';
  moreBtn.className = 'btn';
  const lastDivider = document.querySelector('#intro .divider:last-of-type');
  if (lastDivider) lastDivider.after(moreBtn);

  const USERS_KEY="unmeiUsers", MSGS_KEY="unmeiMsgs";
  function saveMsgs(box){ localStorage.setItem(MSGS_KEY, JSON.stringify(box)); }
  function loadMsgs(){ try{ return JSON.parse(localStorage.getItem(MSGS_KEY)||"{}"); }catch(_){ return {}; } }

  function generateFakeProfiles(count=3){
    const sampleFaces=["しお顔","ソース顔","とんこつ顔","砂糖顔","しょうゆ顔"];
    const sampleMBTI=["INTJ","INFP","ENTP","ENFJ","ISFP","ESTP"];
    const sampleCountries=["日本","韓国","アメリカ","フランス","ドイツ","イタリア"];
    const sampleNames=["あや","Kuma","Lily","John","みさ","Yuta","Mina","Alex"];
    const arr=[];
    for(let i=0;i<count;i++){
      arr.push({
        id:"fake"+Math.random().toString(36).slice(2),
        displayName: sampleNames[Math.floor(Math.random()*sampleNames.length)],
        mbti: sampleMBTI[Math.floor(Math.random()*sampleMBTI.length)],
        face: sampleFaces[Math.floor(Math.random()*sampleFaces.length)],
        country: sampleCountries[Math.floor(Math.random()*sampleCountries.length)],
        age: String(18+Math.floor(Math.random()*20)),
        img:`https://randomuser.me/api/portraits/${Math.random()>0.5?'women':'men'}/${Math.floor(Math.random()*80)}.jpg`,
      });
    }
    return arr;
  }

  /* ===== 紹介カード描画 ===== */
  function renderIntro(list){
    introCards.innerHTML='';
    list.forEach(u=>{
      const card=document.createElement('div');
      card.className='card';
      card.innerHTML = `
        <img src="${u.img}" alt="${u.displayName}" style="width:160px;height:160px;border-radius:50%;object-fit:cover;border:2px solid var(--gold);">
        <div class="meta">
          <strong>${u.displayName}</strong><br>
          ${u.mbti} / ${u.face}<br>
          ${u.country}<br>
          <small>${u.age}歳</small>
        </div>
        <button class="btn send-btn" data-id="${u.id}"> メッセージを送る</button>
      `;
      introCards.appendChild(card);
    });

    introCards.querySelectorAll('.send-btn').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const id = btn.dataset.id;
        const u = list.find(x=>x.id===id);
        goChat(u);
      });
    });
  }

  /* ===== チャット画面 ===== */
  let currentPartner = null;
  function goChat(u){
    document.getElementById('main').classList.add('hidden');
    document.getElementById('home').classList.add('hidden');
    document.getElementById('logout').classList.add('hidden');
    intro.classList.add('hidden');
    chat.classList.remove('hidden');

    currentPartner=u;
    document.getElementById('chatName').textContent=` ${u.displayName} とのチャット`;
    renderChat();
  }

  function renderChat(){
    chatWindow.innerHTML='';
    const box=loadMsgs();
    const msgs=box[currentPartner.id]||[];
    msgs.forEach(m=>{
      const wrap=document.createElement('div');
      wrap.className='chat-msg';
      const b=document.createElement('div');
      b.className='bubble '+(m.from==='me'?'from-me':'from-them');
      b.textContent=m.text;
      wrap.appendChild(b);
      chatWindow.appendChild(wrap);
    });
    chatWindow.scrollTop=chatWindow.scrollHeight;
  }

  document.getElementById('sendMsg').addEventListener('click',()=>{
    const text=chatInput.value.trim();
    if(!text) return;
    const box=loadMsgs();
    box[currentPartner.id]=box[currentPartner.id]||[];
    box[currentPartner.id].push({from:'me',text});
    setTimeout(()=>{
      box[currentPartner.id].push({from:'them',text:'ありがとう'});
      saveMsgs(box);
      renderChat();
    },1000);
    saveMsgs(box);
    chatInput.value='';
    renderChat();
  });

  document.getElementById('backToIntro').addEventListener('click',()=>{
    chat.classList.add('hidden');
    intro.classList.remove('hidden');
  });

  // 初回：ランダム3人で埋める
  let currentList=generateFakeProfiles(3);
  renderIntro(currentList);

  // もっと見る→新しい3人に差替え
  moreBtn.addEventListener('click',()=>{
    currentList=generateFakeProfiles(3);
    renderIntro(currentList);
  });
})();
</script>
</body>
</html>
